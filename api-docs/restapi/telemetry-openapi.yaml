openapi: 3.0.3
info:
  title: Telemetry Service API
  description: Telemetry data collection and time-series storage for Smart Home system
  version: 1.0.0
  contact:
    name: Smart Home Team
    email: dev@warmhouse.com

servers:
  - url: http://localhost:8084/api/v1
    description: Development server

security:
  - BearerAuth: []

paths:
  /telemetry:
    post:
      summary: Store telemetry data
      description: Store sensor measurement data from devices
      tags:
        - Telemetry Data
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetryDataCreate'
            example:
              device_id: "550e8400-e29b-41d4-a716-446655440001"
              house_id: "550e8400-e29b-41d4-a716-446655440020"
              location_id: "550e8400-e29b-41d4-a716-446655440030"
              measurement_type: "temperature"
              value: 23.5
              unit: "celsius"
              quality: "good"
              timestamp: "2024-12-20T15:30:00Z"
              tags: {"sensor_type": "digital"}
      responses:
        '201':
          description: Telemetry data stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryData'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      summary: Query telemetry data
      description: Query historical telemetry data with filtering
      tags:
        - Telemetry Data
      parameters:
        - name: device_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: measurement_type
          in: query
          schema:
            type: string
          example: "temperature"
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
          example: "2024-12-20T00:00:00Z"
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
          example: "2024-12-20T23:59:59Z"
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Telemetry data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TelemetryData'
                  pagination:
                    type: object
                    properties:
                      count:
                        type: integer
                      has_next:
                        type: boolean
              example:
                data:
                  - measurement_id: "550e8400-e29b-41d4-a716-446655440101"
                    device_id: "550e8400-e29b-41d4-a716-446655440001"
                    house_id: "550e8400-e29b-41d4-a716-446655440020"
                    location_id: "550e8400-e29b-41d4-a716-446655440030"
                    measurement_type: "temperature"
                    value: 23.5
                    unit: "celsius"
                    quality: "good"
                    timestamp: "2024-12-20T15:30:00Z"
                    tags: {"sensor_type": "digital"}
                pagination:
                  count: 1
                  has_next: false
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /telemetry/devices/{deviceId}/latest:
    get:
      summary: Get latest measurements
      description: Get the most recent measurements for a specific device
      tags:
        - Telemetry Data
      parameters:
        - name: deviceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: measurement_types
          in: query
          description: Comma-separated list of measurement types
          schema:
            type: string
          example: "temperature,humidity,battery_level"
      responses:
        '200':
          description: Latest measurements retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  device_id:
                    type: string
                    format: uuid
                  measurements:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/LatestMeasurement'
              example:
                device_id: "550e8400-e29b-41d4-a716-446655440001"
                measurements:
                  temperature:
                    value: 23.5
                    unit: "celsius"
                    timestamp: "2024-12-20T15:30:00Z"
                    quality: "good"
                  humidity:
                    value: 45.2
                    unit: "percent"
                    timestamp: "2024-12-20T15:30:00Z"
                    quality: "good"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /metrics/devices/{deviceId}:
    get:
      summary: Get device metrics
      description: Get aggregated metrics for a device
      tags:
        - Device Metrics
      parameters:
        - name: deviceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: metric_name
          in: query
          schema:
            type: string
          example: "avg_temperature"
        - name: aggregation_period
          in: query
          schema:
            type: string
            enum: [hourly, daily, weekly, monthly]
            default: daily
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          example: "2024-12-01"
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          example: "2024-12-20"
      responses:
        '200':
          description: Device metrics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  device_id:
                    type: string
                    format: uuid
                  metrics:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeviceMetric'
              example:
                device_id: "550e8400-e29b-41d4-a716-446655440001"
                metrics:
                  - metric_id: "550e8400-e29b-41d4-a716-446655440201"
                    metric_name: "avg_temperature"
                    metric_value: 23.2
                    aggregation_period: "daily"
                    calculated_at: "2024-12-20T23:59:59Z"
                    period_start: "2024-12-20T00:00:00Z"
                    period_end: "2024-12-20T23:59:59Z"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      summary: Health check
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  influxdb_status:
                    type: string
                    example: "connected"
                  cache_status:
                    type: string
                    example: "connected"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    TelemetryData:
      type: object
      description: TelemetryData entity as defined in ER diagram
      required:
        - measurement_id
        - device_id
        - house_id
        - location_id
        - measurement_type
        - value
        - timestamp
      properties:
        measurement_id:
          type: string
          format: uuid
          description: UUID primary key
        device_id:
          type: string
          format: uuid
          description: Reference to Device entity
        house_id:
          type: string
          format: uuid
          description: Reference to House entity
        location_id:
          type: string
          format: uuid
          description: Reference to Location entity
        measurement_type:
          type: string
          maxLength: 50
          description: Type of measurement VARCHAR(50)
        value:
          type: number
          format: double
          description: Measurement value DOUBLE PRECISION
        unit:
          type: string
          maxLength: 20
          description: Unit of measurement VARCHAR(20)
        quality:
          type: string
          maxLength: 20
          description: Data quality indicator VARCHAR(20)
        timestamp:
          type: string
          format: date-time
          description: Measurement timestamp
        tags:
          type: object
          description: Additional tags JSONB
        metadata:
          type: object
          description: Additional metadata JSONB

    TelemetryDataCreate:
      type: object
      required:
        - device_id
        - house_id
        - location_id
        - measurement_type
        - value
        - timestamp
      properties:
        device_id:
          type: string
          format: uuid
        house_id:
          type: string
          format: uuid
        location_id:
          type: string
          format: uuid
        measurement_type:
          type: string
          maxLength: 50
        value:
          type: number
          format: double
        unit:
          type: string
          maxLength: 20
        quality:
          type: string
          maxLength: 20
          default: "good"
        timestamp:
          type: string
          format: date-time
        tags:
          type: object
        metadata:
          type: object

    LatestMeasurement:
      type: object
      properties:
        value:
          type: number
          format: double
        unit:
          type: string
        timestamp:
          type: string
          format: date-time
        quality:
          type: string

    DeviceMetric:
      type: object
      description: DeviceMetrics entity as defined in ER diagram
      required:
        - metric_id
        - device_id
        - house_id
        - metric_name
        - metric_value
        - calculated_at
        - period_start
        - period_end
      properties:
        metric_id:
          type: string
          format: uuid
          description: UUID primary key
        device_id:
          type: string
          format: uuid
          description: Reference to Device entity
        house_id:
          type: string
          format: uuid
          description: Reference to House entity
        metric_name:
          type: string
          maxLength: 100
          description: Metric name VARCHAR(100)
        metric_value:
          type: number
          format: double
          description: Calculated metric value DOUBLE PRECISION
        aggregation_period:
          type: string
          maxLength: 20
          description: Aggregation period VARCHAR(20)
        calculated_at:
          type: string
          format: date-time
          description: Calculation timestamp
        period_start:
          type: string
          format: date-time
          description: Period start timestamp
        period_end:
          type: string
          format: date-time
          description: Period end timestamp

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

tags:
  - name: Telemetry Data
    description: Telemetry data collection and querying
  - name: Device Metrics
    description: Aggregated device metrics
  - name: Health
    description: Service health monitoring 